<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js?client=ca-pub-6150405281394443" crossorigin="anonymous"></script>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZC93ESXDWX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-ZC93ESXDWX');
  </script>

  <!-- Meta -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#111111" />
  <title>Trend - HypeRank</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: #111;
      color: white;
      font-family: 'Urbanist', sans-serif;
      display: flex;
      flex-direction: column;
    }

    .content-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 2rem 1rem 3rem;
    }

    .trend-result {
      max-width: 600px;
      margin: 0 auto;
    }

    .bar {
      height: 24px;
      margin: 0.5rem 0;
      border-radius: 8px;
      line-height: 24px;
      font-weight: bold;
    }

    .fire-bar {
      background: #ff3c3c;
      color: white;
    }

    .dead-bar {
      background: #555;
      color: white;
    }

    /* ✅ Loader Styles */
    #loaderOverlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.4s ease;
    }

    #loaderOverlay.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .loader-icon {
      animation: bounce 1.2s infinite;
      width: 48px;
      height: 48px;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-12px); }
    }

    @media (max-width: 768px) {
      .trend-result {
        max-width: 100%;
        padding: 0 1rem;
      }

      #trendInfo > div {
        overflow-x: hidden;
      }

      #trendInfo > div > div {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box;
      }

      .bar-container {
        padding: 0 0.5rem;
      }

      .bar {
        font-size: 0.85rem;
        height: 20px;
        line-height: 20px;
      }
    }
  </style>
</head>

<body>
  <!-- ✅ Loader HTML -->
  <div id="loaderOverlay">
    <img src="/assets/arrow-logo.png" alt="Loading..." class="loader-icon" />
  </div>

  <div id="siteHeader"></div>

  <main class="content-wrapper">
    <div class="trend-result">
      <h1>Trend Search</h1>
      <div id="resultBox">Loading...</div>
      <div id="trendInfo"></div>
    </div>
  </main>

  <div id="siteFooter"></div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.5/+esm';

    const supabaseUrl = 'https://rrnucumzptbwdxtkccyx.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJybnVjdW16cHRid2R4dGtjY3l4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxMDcxNDAsImV4cCI6MjA2NzY4MzE0MH0.HH923Txx1G6YXlJcKaDFVpEBK6WuLRT7adqQRi_Isj0';
    const supabase = createClient(supabaseUrl, supabaseKey);

    const query = new URLSearchParams(window.location.search).get("term")?.toLowerCase();
    const resultBox = document.getElementById("resultBox");
    const trendInfo = document.getElementById("trendInfo");

    function similarity(a, b) {
      a = a.toLowerCase(); b = b.toLowerCase();
      if (a === b) return 1;
      if (a.includes(b) || b.includes(a)) return 0.7;
      let matches = 0;
      for (let i = 0; i < Math.min(a.length, b.length); i++) {
        if (a[i] === b[i]) matches++;
      }
      return matches / Math.max(a.length, b.length);
    }

    async function fetchAndMatchTrend() {
      const { data: trends, error } = await supabase.from("trends").select("*");
      if (error || !trends || trends.length === 0) {
        resultBox.textContent = "There was an error loading trend data.";
        return;
      }

      const match = trends.find(t => t.name.toLowerCase() === query || t.label.toLowerCase() === query);

      if (match) {
        const firePercent = Math.round((match.hype / match.votes) * 100);
        const deadPercent = 100 - firePercent;
        resultBox.innerHTML = `<strong>${match.label}</strong>:`;
        trendInfo.innerHTML = `
          <p style="margin: 1rem auto; max-width: 400px;">${match.description}</p>
          <div style="display: flex; justify-content: center; margin-top: 2rem;">
            <div style="background: #1a1a1a; padding: 1.5rem; border-radius: 12px; width: 700px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);">
              <h3>Total Votes: ${match.votes}</h3>
              <div class="bar-container" style="margin-top: 1rem; text-align: left;">
                <div style="margin-bottom: 0.3rem; font-weight: bold;"><i class="fas fa-fire" style="color:#ff3c3c;"></i> Hype: ${firePercent}%</div>
                <div class="bar fire-bar" style="width:${firePercent}%; min-width: 4px;"></div>
                <div style="margin-top: 1rem; margin-bottom: 0.3rem; font-weight: bold;"><i class="fas fa-skull" style="color:#aaa;"></i> Dead: ${deadPercent}%</div>
                <div class="bar dead-bar" style="width:${deadPercent}%; min-width: 4px;"></div>
              </div>
            </div>
          </div>`;
      } else {
        resultBox.innerHTML = `No trends found for "<strong>${query}</strong>".`;
        let bestMatch = null, bestScore = 0;
        for (const t of trends) {
          const score = similarity(query, t.name);
          if (score > bestScore) {
            bestScore = score;
            bestMatch = t.name;
          }
        }
        if (bestScore >= 0.5 && bestMatch) {
          trendInfo.innerHTML = `Did you mean: <a href="trend.html?term=${encodeURIComponent(bestMatch)}" style="color:#ff3c3c;">${bestMatch}</a>?`;
        }
      }
    }

    fetchAndMatchTrend();
  </script>

 <script src="/includes/includes.js"></script>
<script>
  const includesLoaded = { header: false, footer: false };
  let pageReady = false;

  function tryHideLoader() {
    if (includesLoaded.header && includesLoaded.footer && pageReady) {
      const loader = document.getElementById("loaderOverlay");
      if (loader) loader.classList.add("fade-out");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadInclude("siteHeader", "/includes/header.html", () => {
      const nav = document.getElementById("headerNav");
      if (nav) {
        nav.innerHTML = `
          <a href="https://hyperank.ca">← Back to Home</a>
          <a href="https://hyperank.ca/dictionary">Dictionary</a>
        `;
      }
      includesLoaded.header = true;
      tryHideLoader();
    });

    loadInclude("siteFooter", "/includes/footer.html", () => {
      includesLoaded.footer = true;
      tryHideLoader();
    });
  });

  window.addEventListener("load", () => {
    if (typeof fetchAndMatchTrend === 'function') {
      fetchAndMatchTrend().then(() => {
        pageReady = true;
        tryHideLoader();
      });
    } else {
      pageReady = true;
      tryHideLoader();
    }
  });
</script>

<!-- Other content... -->

<script>
  // Save scroll position before reload
  window.addEventListener('beforeunload', () => {
    localStorage.setItem('scrollY', window.scrollY);
  });

  // Restore scroll position after reload
  window.addEventListener('load', () => {
    const scrollY = localStorage.getItem('scrollY');
    if (scrollY !== null) {
      window.scrollTo(0, parseInt(scrollY));
      localStorage.removeItem('scrollY');
    }
  });
</script>

</body>
</html>
